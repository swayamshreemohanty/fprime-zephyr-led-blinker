# fprime-zephyr-led-blinker F' project

This project was auto-generated by the F' utility tool. 

F´ (F Prime) is a component-driven framework that enables rapid development and deployment of spaceflight and other embedded software applications.
**Please Visit the F´ Website:** https://nasa.github.io/fprime/.

## Quick Start

```bash
# 1. Install system dependencies
sudo apt-get update
sudo apt-get install -y gperf python3-dev cmake ninja-build device-tree-compiler

# 2. Set up Python virtual environment
python3 -m venv .venv
source .venv/bin/activate

# 3. Install Python dependencies
pip install --upgrade pip
pip install west jsonschema pyelftools
pip install -r fprime/requirements.txt

# 4. Initialize west workspace (first time only)
west init -l .
west update  # Downloads Zephyr v4.3.0 and modules (~2GB, 10-20 minutes)

# 5. (Optional but recommended) Install Zephyr SDK 0.17.0
# Download from https://github.com/zephyrproject-rtos/sdk-ng/releases/tag/v0.17.0
# For ARM64 (Raspberry Pi):
cd ~
wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-aarch64.tar.xz
tar xf zephyr-sdk-0.17.0_linux-aarch64.tar.xz
cd zephyr-sdk-0.17.0
./setup.sh -t arm-zephyr-eabi

# Return to project directory
cd ~/Documents/work/serendipityspace/fprime-zephyr-led-blinker
source .venv/bin/activate

# 6. Build for your board
fprime-util generate -DBOARD=nucleo_h7a3zi_q  # or teensy41, teensy40, etc.
fprime-util build -j4

# 7. Flash firmware (example for STM32)
st-flash write build-fprime-automatic-zephyr/zephyr/zephyr.bin 0x08000000

# 8. Run F' Ground Data System
fprime-gds -n \
  --dictionary ./build-artifacts/zephyr/LedBlinker/dict/LedBlinkerTopologyAppDictionary.xml \
  --comm-adapter uart --uart-device /dev/ttyACM0 --uart-baud 115200
```

**⚠️ Important Notes:**
- Do **NOT** set `ZEPHYR_BASE` environment variable - the local west workspace manages paths automatically
- Always activate the virtual environment before building: `source .venv/bin/activate`
- Zephyr SDK 0.17.0 is optional but provides better optimization and smaller binaries


## Detailed Setup Guide

### Prerequisites

This project uses Zephyr RTOS v4.3.0 managed by a local west workspace. The workspace is self-contained within the project directory.

**System Requirements:**
- Linux (tested on Debian/Ubuntu, Raspberry Pi OS)
- Python 3.11 or newer (tested with Python 3.13)
- 2GB+ free disk space for Zephyr and modules
- Internet connection for downloading dependencies

### 1. Install System Dependencies

```sh
sudo apt-get update
sudo apt-get install -y \
  gperf \
  python3-dev \
  python3-venv \
  cmake \
  ninja-build \
  device-tree-compiler \
  git
```

**Package descriptions:**
- `gperf` - Perfect hash function generator (required by Zephyr)
- `python3-dev` - Python development headers
- `cmake` - Build system (minimum 3.20.0)
- `ninja-build` - Fast build tool
- `device-tree-compiler` - Device tree compiler (dtc)
- `git` - Version control

### 2. Set Up Python Virtual Environment

```sh
# From the project root directory
python3 -m venv .venv
source .venv/bin/activate
```

### 3. Install Python Dependencies

```sh
# Upgrade pip to latest version
pip install --upgrade pip

# Install west (Zephyr meta-tool)
pip install west

# Install Zephyr Python requirements
pip install jsonschema pyelftools PyYAML

# Install F' requirements
pip install -r fprime/requirements.txt
```

**Note for Python 3.13 users:** The fprime requirements may need upgraded versions:
```sh
pip install lxml==5.3.0 pyzmq==26.2.0 legacy-cgi
```

### 4. Initialize West Workspace (First Time Only)

The project includes `west.yml` which specifies Zephyr v4.3.0 and required modules.

```sh
# Initialize west workspace using the local manifest
west init -l .

# Download Zephyr and all required modules
west update
```

**What happens during `west update`:**
- Downloads Zephyr v4.3.0 into `zephyr/` directory
- Downloads required modules into `modules/` directory:
  - `hal_stm32` - STM32 Hardware Abstraction Layer
  - `cmsis` - ARM Cortex Microcontroller Software Interface Standard
  - Many other Zephyr dependencies
- Takes 10-20 minutes and requires ~2GB disk space

### 5. Install Zephyr SDK 0.17.0 (Optional but Recommended)

The Zephyr SDK provides optimized cross-compilation toolchains. While CMake can use system gcc as fallback, the SDK provides better optimization and smaller binaries.

**For ARM64 (Raspberry Pi):**
```sh
cd ~
wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-aarch64.tar.xz
tar xf zephyr-sdk-0.17.0_linux-aarch64.tar.xz
cd zephyr-sdk-0.17.0
./setup.sh -t arm-zephyr-eabi
```

**For x86_64:**
```sh
cd ~
wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-x86_64.tar.xz
tar xf zephyr-sdk-0.17.0_linux-x86_64.tar.xz
cd zephyr-sdk-0.17.0
./setup.sh -t arm-zephyr-eabi
```

**Set SDK path (optional):**
```sh
# Add to ~/.bashrc or export in each terminal
export ZEPHYR_SDK_INSTALL_DIR=~/zephyr-sdk-0.17.0
```

### 6. Verify Setup

After setup, verify your workspace:

```sh
# Check west projects
west list | head -5
# Should show: manifest, zephyr, and modules

# Verify directory structure
ls -d zephyr modules .venv
# Should all exist

# Check Python packages
pip list | grep -E "west|fprime|jsonschema"
```

**Expected directory structure:**
```
fprime-zephyr-led-blinker/
├── .venv/              # Python virtual environment
├── .west/              # West workspace metadata
├── zephyr/             # Zephyr RTOS v4.3.0
├── modules/            # Zephyr modules (HAL, CMSIS, etc.)
├── fprime/             # F' framework (submodule)
├── fprime-zephyr/      # F' Zephyr integration (submodule)
├── Components/         # Custom F' components
├── Stm32LedBlinker/    # Deployment
└── west.yml            # West manifest
```

**Important:** The toolchain is set to `zephyr` in `settings.ini`. Do not change this.

### Limitations

Unfortunately, you can only build one deployment at a time. If you have multiple deployments in a project, comment out other deployments under `project.cmake` so that you build one at a time.

### 7. Building the Deployment

**⚠️ Critical:** Do **NOT** set `ZEPHYR_BASE` environment variable! The west workspace manages all paths automatically.

```sh
# Always activate virtual environment first
source .venv/bin/activate

# Generate build configuration for your target board
fprime-util generate -DBOARD=nucleo_h7a3zi_q

# Build firmware (adjust -j based on CPU cores)
fprime-util build -j4
```

**Supported Boards:**

| Board | Description | Tested |
|-------|-------------|--------|
| `nucleo_h7a3zi_q` | STM32 Nucleo H7A3ZI-Q | ✅ Yes |
| `teensy41` | Teensy 4.1 | ✅ Yes |
| `teensy40` | Teensy 4.0 | ⚠️ Partial |

> For other boards, see [Zephyr Supported Boards](https://docs.zephyrproject.org/latest/boards/index.html). Additional configuration may be required.

**Building for Different Boards:**

To switch boards, purge the build cache and regenerate:

```sh
# Clean build directory
fprime-util purge zephyr -f

# Generate for new board
fprime-util generate -DBOARD=teensy41

# Build
fprime-util build -j4
```

**Build Output Location:**

```
build-fprime-automatic-zephyr/zephyr/
├── zephyr.bin    # Raw binary (for st-flash, etc.)
├── zephyr.elf    # ELF with debug symbols
├── zephyr.hex    # Intel HEX format
└── zephyr.uf2    # UF2 format (for drag-and-drop)
```

**⚠️ Note:** Do NOT use binaries from `build-artifacts/`. Use only the files from `build-fprime-automatic-zephyr/zephyr/`.

The only tested board was the Teensy 4.1. Building for other boards may require you to edit the `proj.conf` file and add a `.overlay` file inside of the [`boards/`](./boards/) directory.

### Uploading to board
Currently, there is a [`Stub.cpp`](./LedBlinker/Stub.cpp) file in the LedBlinker deployment. This is because the Zephyr build system generates its own binary executable independent from the Fprime build system. The Zephyr build system works, and links all of the necessary Zephyr and Fprime libraries. However, the Fprime build system still attempts to build its own separate deployment and does not link the proper Zephyr libraries, so it fails. Having a `Stub.cpp` forcess the Fprime deployment to build a binary that does nothing, so it doesn't attempt to look for Zephyr dependencies. 

TLDR: Do not use any binary files generated in the `build-artifacts` directory. They do nothing. Instead, the executable you want will be located in `build-fprime-automatic-zephyr/zephyr/`. 

There should be a few binaries that you can use to upload, which varies depending on the board you are using:
- `zephyr.bin`
- `zephyr.elf`
- `zephyr.exe`
- `zephyr.hex`
- `zephyr.uf2`
- Probably more

### Run GDS
We have to give wrx access to ACM device. Why? idk.
```sh
sudo chmod 0777 /dev/ttyACM0
fprime-gds -n --dictionary ./build-artifacts/zephyr/LedBlinker/dict/LedBlinkerTopologyAppDictionary.xml --comm-adapter uart --uart-device /dev/ttyACM0 --uart-baud 115200
```